<p class="lead">Dandelion is an open-source project. <a target="_blank" href="https://github.com/symbiota-coop/dandelion">View the code on Github</a></p>

<div class="mb-3">
  <% form_tag '', method: 'get', class: 'submitOnChange form-inline' do %>
    <div class="row no-gutters">
      <div class="col-auto">
        <%= month_field_tag :month, class: 'form-control', value: params[:month] || Date.today.strftime('%Y-%m') %>
      </div>
      <div class="col-auto ml-2">
        <%= submit_tag 'View updates', class: 'btn btn-primary' %>
      </div>
    </div>
  <% end %>
</div>

<% 
client = Octokit::Client.new(access_token: ENV['GITHUB_ACCESS_TOKEN'])

# Get selected month or default to current month
selected_month = params[:month] || Date.today.strftime('%Y-%m')
year, month = selected_month.split('-').map(&:to_i)

# Calculate date range for the selected month
start_date = Date.new(year, month, 1)
end_date = Date.new(year, month, -1)

repo = "symbiota-coop/dandelion"

commits = client.commits(repo, since: start_date.iso8601, until: end_date.iso8601)
%>

<% if commits.any? %>
  <% if start_date < Date.today.beginning_of_month %>
    <%= stash_partial(:'code/commit_summary', key: "/commit_summary?month=#{selected_month}", locals: { commits: commits, client: client, repo: repo }) %>
  <% else %>
    <%= cp(:'code/commit_summary', key: "/commit_summary?month=#{selected_month}", locals: { commits: commits, client: client, repo: repo }, expires: 1.day.from_now) %>
  <% end %>

  <% commits.group_by { |c| c.commit.author.date.to_date }.each do |date, day_commits| %>
    <h6 class="mt-4">Commits on <%= date.strftime('%b %d, %Y') %></h6>
    <div class="table-responsive">
      <table class="table table-sm">
        <tbody>
          <% day_commits.each do |commit| %>
            <tr>
              <td style="width: 70px">
                <a href="<%= commit.html_url %>" target="_blank">
                  <%= commit.sha[0..6] %>
                </a>
              </td>
              <td data-toggle="tooltip" title="AI-generated summary âœ¨">
                <%== md(
                commit.commit.message
                .gsub('_', '\_').gsub(/\p{Emoji_Presentation}|\p{Extended_Pictographic}/u, '<br />\0')
                .sub(/^<br \/>/, '')
                ) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
<% else %>
  <p class="text-center mb-0">No commits found.</p>
<% end %>

<%= partial :'code/network' %>

<script>
  $(document).ready(function() {
    // Handle month selection form submission
    $('#commit-month-form').on('submit', function(e) {
      e.preventDefault();
      const selectedMonth = $('#commit-month').val();
      window.location.href = '/dev?month=' + selectedMonth;
    });

    // Set the month selector to the current selection if available
    const urlParams = new URLSearchParams(window.location.search);
    const monthParam = urlParams.get('month');
    if (monthParam) {
      $('#commit-month').val(monthParam);
    }
  });
</script>