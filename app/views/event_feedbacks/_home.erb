<style>
  .grid-sizer, .grid-item {  width: 100% }
  @media(min-width: 768px) {
    .grid-sizer, .grid-item {  width: 50% }
  }
  .grid-item img { padding: 0.1rem }
</style>
<script>
  $(window).on('load', function () {
    $('.grid').masonry({
      itemSelector: '.grid-item',
      columnWidth: '.grid-sizer',
      percentPosition: true
    })
  })
</script>
<div class="grid mt-5">
  <% 
  # Use aggregation to join with accounts and events at database level
  # Step 1: Find eligible accounts (this should be fast with proper indexes)
  eligible_account_ids = Account.and(
    :has_image => true,
    :has_signed_in => true,
    :hidden => false,
  ).pluck(:id)
  
  # Step 2: Find the most recent 5-star feedback from each eligible account
  # Using a simpler aggregation that only works with filtered account IDs
  pipeline = [
    { '$match' => { 
      'anonymise' => false, 
      'has_public_answers' => true, 
      'rating' => 5,
      'account_id' => { '$in' => eligible_account_ids }
    } },
    { '$sort' => { 'account_id' => 1, 'created_at' => -1 } },
    { '$group' => { '_id' => '$account_id', 'feedback' => { '$first' => '$$ROOT' } } },
    { '$replaceRoot' => { 'newRoot' => '$feedback' } },
    { '$sort' => { 'created_at' => -1 } },
    { '$limit' => 10 }
  ]
  
  EventFeedback.collection.aggregate(pipeline).each { |doc|
  event_feedback = EventFeedback.new(doc.select { |k, _v| EventFeedback.fields.keys.include?(k.to_s) })
  account = event_feedback.account
  next if account.name.include?('_')
  quote = event_feedback.public_answers.map { |q,a| a unless a.blank? }.compact.join('<br /><br />')
  next if quote.length > 500 %>
  <div class="grid-sizer"></div>
  <div class="grid-item">

    <div class="row no-gutters">
      <div class="col-auto mr-2"><i class="bi bi-quote"></i></div>
      <div class="col">
        <big>
          <%= partial :'accounts/square', locals: { klass: 'float-left mr-3 mb-3', account: account, width: '150px' } %>
          <a class="home-feedback" href="/events/<%= event_feedback.event.id %>">
            <%== Sanitize.fragment(quote, Sanitize::Config::DANDELION) %>
          </a>
        </big>

        <div class="my-2" style="font-size: 2em; white-space: nowrap;">
          <% event_feedback.rating.times do %><i class="bi bi-star-fill"></i><% end %>
        </div>

        <p class="mb-5">
          <a href="/u/<%= account.username %>"><%= account.name %></a> on <a href="/events/<%= event_feedback.event.id %>"><%= event_feedback.event.name %></a>
          <small><%= timeago event_feedback.created_at %></small>
        </p>

      </div>
    </div>
  </div>
  <% } %>
</div>
