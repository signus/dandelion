<style>
  .grid-sizer, .grid-item {  width: 100% }
  @media(min-width: 768px) {
    .grid-sizer, .grid-item {  width: 50% }
  }
  .grid-item img { padding: 0.1rem }
</style>
<script>
  $(window).on('load', function () {
    $('.grid').masonry({
      itemSelector: '.grid-item',
      columnWidth: '.grid-sizer',
      percentPosition: true
    })
  })
</script>
<div class="grid mt-5">
  <% 
  # Use aggregation to join with accounts and events at database level
  pipeline = [
    { '$match' => { 'anonymise' => false, 'public_answers' => { '$ne' => nil }, 'rating' => 5 } },
    # Sort by account_id then created_at so $first picks the latest per account without in-memory sort
    { '$sort' => { 'account_id' => 1, 'created_at' => -1 } },
    # Group by account_id to get only one feedback per account (most recent due to sort)
    { '$group' => { '_id' => '$account_id', 'feedback' => { '$first' => '$$ROOT' } } },
    { '$replaceRoot' => { 'newRoot' => '$feedback' } },
    # Perform lookups after grouping to reduce join volume
    { '$lookup' => { 'from' => 'accounts', 'localField' => 'account_id', 'foreignField' => '_id', 'as' => 'account_doc' } },
    { '$lookup' => { 'from' => 'events', 'localField' => 'event_id', 'foreignField' => '_id', 'as' => 'event_doc' } },
    { '$unwind' => '$account_doc' },
    { '$unwind' => '$event_doc' },
    { '$match' => { 
        'account_doc.has_image' => true, 
        'account_doc.has_signed_in' => true, 
        'account_doc.hidden' => { '$ne' => true },
        'account_doc.name' => { '$not' => { '$regex' => '_' } }
      } 
    },
    # Final sort by created_at to get the most recent feedbacks
    { '$sort' => { 'created_at' => -1 } },
    { '$limit' => 10 }
  ]
  
  EventFeedback.collection.aggregate(pipeline).each { |doc|
  event_feedback = EventFeedback.new(doc.select { |k, _v| EventFeedback.fields.keys.include?(k.to_s) })
  account = event_feedback.account
  quote = event_feedback.public_answers.map { |q,a| a unless a.blank? }.compact.join('<br /><br />')
  next if quote.length > 500 %>
  <div class="grid-sizer"></div>
  <div class="grid-item">

    <div class="row no-gutters">
      <div class="col-auto mr-2"><i class="bi bi-quote"></i></div>
      <div class="col">
        <big>
          <%= partial :'accounts/square', locals: { klass: 'float-left mr-3 mb-3', account: account, width: '150px' } %>
          <a class="home-feedback" href="/events/<%= event_feedback.event.id %>">
            <%== Sanitize.fragment(quote, Sanitize::Config::DANDELION) %>
          </a>
        </big>

        <div class="my-2" style="font-size: 2em; white-space: nowrap;">
          <% event_feedback.rating.times do %><i class="bi bi-star-fill"></i><% end %>
        </div>

        <p class="mb-5">
          <a href="/u/<%= account.username %>"><%= account.name %></a> on <a href="/events/<%= event_feedback.event.id %>"><%= event_feedback.event.name %></a>
          <small><%= timeago event_feedback.created_at %></small>
        </p>

      </div>
    </div>
  </div>
  <% } %>
</div>
