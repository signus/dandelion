<% unless @event  %>
  <style>
    #event_stats_filter label { font-weight: bold }
  </style>
  <script>
    $(function () {
      var date = $("#event_stats th").toArray().indexOf($("th[data-col-name='date']")[0])
      var ticketsSold = $("#event_stats th").toArray().indexOf($("th[data-col-name='tickets-sold']")[0])
      var ticketRevenue = $("#event_stats th").toArray().indexOf($("th[data-col-name='ticket-revenue']")[0])
      var organisationTicketRevenueShare = $("#event_stats th").toArray().indexOf($("th[data-col-name='organisation-ticket-revenue-share']")[0])
      var donations = $("#event_stats th").toArray().indexOf($("th[data-col-name='donations']")[0])
      $(document).ajaxStop(function() {
        if (!$('#event_stats').hasClass('dataTable')) {
          var table = $('#event_stats').dataTable({
            bInfo: false,
            paging: false,
            order: [[date, "asc"]],
            oLanguage: {
              sSearch: "Quick search"
            }
          })
          table.on('draw.dt', function() {
            $.each([ticketsSold, ticketRevenue, donations, organisationTicketRevenueShare], function(i,index) {
              var sum = 0
              $('#event_stats tbody tr').each(function() {
                sum += parseFloat($('td:eq('+index+')', this).attr('data-sort'))
              })
              if (i == 0)
                $('tfoot th').eq(index).html(sum);
              else
                $('tfoot th').eq(index).html('<%= money_symbol(@organisation.currency) %>' + sum.toLocaleString());
            });
          })
          $('#event_stats').DataTable().draw();
        }

      $("#event_stats th.hide").each(function() {
        var index = $("#event_stats th").index(this);
        $("#event_stats th").eq(index).hide(); // Hide header
        $("#event_stats td:nth-child(" + (index + 1) + ")").hide(); // Hide all corresponding tds
        $("#event_stats tfoot th").eq(index).hide(); // Hide footer
      })

      })
    })
  </script>
<% end %>

<% organisation = params[:cohost] ? Organisation.find_by(slug: params[:cohost]) : @organisation %>

<table id="event_stats" class="table table-striped table-hover table-sm" style="font-size: 0.9em">
  <thead class="bg-white">
    <tr>
      <th>Name</th>
      <th></th>
      <th style="min-width: 12.5em" data-col-name="date">Date</th>
      <th>Coordinator</th>
      <% if organisation.stripe_client_id %>
        <th>Organiser</th>
      <% else %>
        <th class="hide"></th>
      <% end %>
      <th>Facilitators</th>
      <th>Tags</th>
      <th>Activity</th>
      <th>Local group</th>
      <th>Facebook event</th>
      <th>30d views</th>
      <th data-col-name="tickets-sold">Tickets sold</th>
      <th>Checked in</th>
      <th data-col-name="ticket-revenue">Ticket revenue</th>
      <% if organisation.stripe_client_id %>
        <th data-col-name="organisation-ticket-revenue-share">Organisation ticket revenue share</th>
      <% else %>
        <th class="hide"></th>
      <% end %>
      <th data-col-name="donations">Donations</th>
      <% if organisation.stripe_client_id %>
        <th>Total due to organisation</th>
        <th>Revenue reported by Stripe</th>
        <th>Stripe fees</th>
      <% else %>
        <th class="hide"></th>
        <th class="hide"></th>
        <th class="hide"></th>
      <% end %>
      <th>Credit due</th>
      <th>Feedback</th>
    </tr>
  </thead>
  <% events.each { |event| %>
  <tr data-pagelet-url="/events/<%= event.id %>/stats_row<%= "?timezone=#{event.start_time.strftime('%Z')}#{"&organisation_id=#{organisation.id}" if organisation}" %>"><% if @event %><%= cp(:'events/event_stats_row', locals: { event: @event, organisation: organisation }, key: "/events/#{@event.id}/stats_row?timezone=#{@event.start_time.strftime('%Z')}#{"&organisation_id=#{organisation.id}" if organisation}") %><% end %></tr>
  <% } %>
  <% unless @event %>
    <tfoot>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <% if organisation.stripe_client_id %>
          <th></th>
        <% else %>
          <th></th>
        <% end %>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <% if organisation.stripe_client_id %>
          <th></th>
        <% else %>
          <th></th>
        <% end %>
        <th></th>
        <% if organisation.stripe_client_id %>
          <th></th>
          <th></th>
          <th></th>
        <% else %>
          <th></th>
          <th></th>
          <th></th>
        <% end %>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
  <% end %>
</table>
