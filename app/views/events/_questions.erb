<% if defined?(questions) 
    q = (questions || '').split("\n").map(&:strip).reject(&:blank?)
    questions_a = q.empty? ? [] : q
else
questions_a = @event.questions_a
end
%>

<% questions_a.each_with_index { |q,i| %>
<div class="form-group links-blank">
  <% if q =~ /^#\s*(.+)/ %>
    <% match = $1 %>
    <% next_question = questions_a[i + 1] %>
    <% if next_question && next_question.match(/\[.*\]/) %>
      <strong><%== Sanitize.fragment(Rinku.auto_link(match), Sanitize::Config::DANDELION) %></strong>
    <% else %>
      <h4><%== Sanitize.fragment(Rinku.auto_link(match), Sanitize::Config::DANDELION) %></h4>
    <% end %>
  <% elsif m = q.match(Order::SELECT_FIELD_REGEX)  %>
    <% # Select field: Question text [option1, option2, option3] %>
    <% question_text = m[1] %>
    <% options = m[2].split(',').map(&:strip) %>
    <div class="form-group">
      <label><%== Sanitize.fragment(Rinku.auto_link(question_text.chomp('*')), Sanitize::Config::DANDELION) %></label>
      <%= select_tag "answers[#{i}]", options: [''] + options, selected: (params[:answers][i] if params[:answers]), required: question_text.ends_with?('*'), class: 'form-control', disabled: defined?(questions) %>
    </div>
  <% elsif m = q.match(/\[(.*)\]/)  %>
    <% # Checkbox: [Question text] %>
    <div class="checkbox-inline">
      <%= check_box_tag "answers[#{i}]", id: "answers-#{i}", checked: ((params[:answers][i] == 'true') if params[:answers]), 'data-required': q.ends_with?('*'), disabled: defined?(questions) %>
      <label class="font-weight-bold" for="answers-<%=i%>">
        <%== Sanitize.fragment(Rinku.auto_link(m[1]), Sanitize::Config::DANDELION) %>
      </label>
    </div>
  <% elsif m = q.match(/\{(.*)\}/)  %>
    <div class="form-group">
      <label><%== Sanitize.fragment(Rinku.auto_link(m[1]), Sanitize::Config::DANDELION) %></label>
      <%= date_field_tag "answers[#{i}]", required: q.ends_with?('*'), class: 'form-control', value: (params[:answers][i] if params[:answers] && params[:answers][i] != '__EMPTY__'), disabled: defined?(questions) %>
    </div>
  <% else %>
    <label><%== Sanitize.fragment(Rinku.auto_link(q.chomp('*')), Sanitize::Config::DANDELION) %></label>
    <div>
      <%= text_area_tag "answers[#{i}]", required: q.ends_with?('*'), class: 'autosize form-control', value: (params[:answers][i] if params[:answers] && params[:answers][i] != '__EMPTY__'), disabled: defined?(questions) %>
    </div>
  <% end %>
</div>
<% } %>