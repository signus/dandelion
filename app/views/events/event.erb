<% if event_admin? %>
  <%= partial :'events/nav', locals: { event: @event } %>
  <% if @event.organisation && !@event.organisation.payment_method? && @event.ticket_types.any? { |ticket_type| (ticket_type.price && ticket_type.price > 0) || ticket_type.range } %>
    <div class="alert alert-warning">
      <p class="mb-0">
        <i class="bi bi-exclamation-triangle-fill"></i> You must <a class="text-warning" href="/o/<%=@event.organisation.slug%>/edit">add either Stripe or Coinbase Commerce details in the Payments tab of your organisation</a> to take payments.
      </p>
    </div>
  <% end %>
  <div data-pagelet-url="/events/<%= @event.id %>/notes" class="mb-3">
    <%= partial :'events/notes' %>
  </div>
<% else %>
  <style>
    #event-image { margin-top: -0.9375rem }
    @media(min-width: 768px) { #event-image { margin-top: -1.5625rem } }
  </style>
<% end %>

<% if params[:tour] || (params[:created] && current_account && current_account.events.count == 1) %>
  <script>
    $(function() {

      if($(window).width() > 992) {

        introJs().setOptions({
          steps: [{
            title: "Nice one!",
            intro: "You've created your first event ðŸŽ‰"
          }, {
            element: $('#content button.dropdown-toggle').last()[0],
            intro: "Here's the admin dropdown for the event"
          }]
        }).start();

      }
    })
  </script>
<% end %>

<div class="row justify-content-center">
  <div class="col-lg-10">
    <% if @event_video %>
      <div class="embed-responsive embed-responsive-16by9 mb-3">
        <video src="<%=@event_video.url%>" type="video/mp4" controls></video>
      </div>
    <% elsif @event_image %>
      <a href="/e/<%=@event.slug%><% if params[:cohost] %>?cohost=<%=params[:cohost]%><% end %>"><img id="event-image" class="w-100 mb-3" src="<%= u @event_image.thumb('1920x1920').url %>"></a>
    <% end %>
    <% if @order %>
      <%= partial :'events/success' %>
    <% end %>
  </div>
</div>
<% unless @order %>
  <% sidebar = false %>
  <% sidebar = true if @event.sold_out? || @event.purchase_url %>
  <% buy_tickets_style = 'class="fixed-bottom bg-white p-3 w-100 d-block d-md-none" style="z-index: 1019; box-shadow: 0px -2px 4px 0px rgba(0,0,0,0.3);"' %>
  <% if @event.purchase_url %>
    <div id="buy-tickets" <%== buy_tickets_style %>>
      <a target="_blank" href="<%=@event.purchase_url%>" class="btn btn-primary btn-block">Book via <%=URI(@event.purchase_url).host.gsub('www.','')%></a>
    </div>
    <style>
      @media(max-width: 991px) { #content { padding-bottom: 4rem } }
    </style>
  <% elsif (params[:ticket_type_id] || !@event.sold_out?) && @event.ticket_types.count > 0 %>
    <% sidebar = true %>
    <div id="buy-tickets" <%== buy_tickets_style %>>
      <a href="javascript:;" onclick="$(this).parent().hide();
            $(window).scrollTop($('#purchase').offset()['top'] - $('#header').height() - 17)
           " class="btn btn-primary btn-block">Get tickets</a>
    </div>
    <script>
      $(function () {
        $(window).scroll(function () {
          if ((window.scrollY + window.innerHeight) > $('#purchase').offset()['top']) {
            $('#buy-tickets').addClass('d-none').removeClass('d-block')
          } else {
            $('#buy-tickets').addClass('d-block').removeClass('d-none')
          }
        })
        $(window).scroll()
      })
    </script>
  <% end %>
  <div class="row">
    <div class="<%= sidebar ? 'col-lg-7' : 'col-lg-12' %>">

      <% n = 1 
      if @event.organisation
        events = ([@event] + @event.organisation.events_for_search.future.and(:name => @event.name, :location => @event.location, :start_time.ne => @event.start_time)).uniq
        n = events.count
     end %>

      <h1 class="mb-1">
        <%= @event.name %>
        <% if n > 1 %>
          <span class="badge badge-primary"><%= pluralize(n, 'dates') %></span>
        <% end %>
        <small>
          <div class="d-inline float-right" data-pagelet-url="/events/<%=@event.id%>/star">
            <%= partial :'events/star', locals: {event: @event} %>
          </div>
        </small>
      </h1>
      <ul style="font-size: 1rem" class="icon-list text-dark mb-1">
        <li>
          <i <% if n > 1 %> style="top: 0.55em"<% end %> data-toggle="tooltip" title="Dates/times" class="bi bi-calendar-event"></i>
          <% if n > 1 %>
            <%= select_tag :event_id, options: events.map { |event| [@event.event_sessions.count > 0 ? concise_when_details(event, with_zone: true) : when_details(event), event.id] }, selected: @event.id, class: 'form-control mb-1', style: 'font-size: 1rem; padding: 0.375rem;', onchange: "window.location = '/events/'+$(this).val()" %>
          <% elsif @event.event_sessions.count > 0 %>
            <%= concise_when_details(@event, with_zone: true) %>
            <span style="font-size: 0.85em">
              <span class="label label-primary"><%= pluralize @event.event_sessions.count, 'session' %></span>
            </span>
          <% else %>
            <%= when_details(@event) %>
          <% end %>
          <% if @event.start_time.to_date != @event.end_time.to_date %>
            <div style="font-size: 0.85em" class="my-1">
              <%= partial :'events/add_event_session', locals: {
          event_sessions: @event.event_sessions.order('start_time asc'),
          add_and_remove: event_admin?,
          new_object: EventSession.new,
          new_url: "/events/#{@event.id}/event_sessions/new",
          destroy_url: "/events/#{@event.id}/event_sessions/destroy"
        } %>
            </div>
          <% end %>
        </li>
        <li><i data-toggle="tooltip" title="Location" class="bi bi-geo-alt-fill"></i>
          <% if @event.location == 'Online' %>
            Online
          <% elsif @event.location =~ URI::regexp %>
            <span class="compact-urls"><a href="<%= @event.location %>"><%= @event.location %></a></span>
          <% else %>
            <a target="_blank" href="https://www.google.co.uk/maps?q=<%= @event.location %>"><%= @event.location %></a>
          <% end %>
        </li>
        <% if @event.slug %>
          <li>
            <i data-toggle="tooltip" title="Event URL" class="bi bi-link"></i>
            <a data-toggle="tooltip" href="<%=ENV['BASE_URI']%>/e/<%=@event.slug%>"><%=ENV['BASE_URI']%>/e/<%=@event.slug%></a>
          </li>
        <% end %>
      </ul>
      <div>
        <%= partial :'events/tag_labels', locals: { event: @event } %>
      </div>
      <%= partial :'events/info_table' %>
      <% if @event.description || @event.organisation.event_footer %>
        <div class="wysiwyg">
          <big>
            <% if @event.description %>
              <% d = Rinku.auto_link(
                (@event.description.include?('<p') || @event.description.include?('<br') ? @event.description : "<p>#{@event.description.gsub("\n", '<br />')}</p>")
                .gsub(%r{<a (href=".+?")>\[\[(.+?)\]\]</a>}, '<a \1 class="btn btn-primary">\2</a>')) %>
              <% if @event.raw_description %>
                <%== d %>
              <% else %>
                <%== Sanitize.fragment(d, Sanitize::Config::DANDELION) %>
              <% end %>
            <% end %>
            <% if !@event.hide_organisation_footer && @event.organisation.event_footer && !@event.zoom_party? %>
              <%== Sanitize.fragment(Rinku.auto_link(@event.organisation.event_footer), Sanitize::Config::DANDELION) %>
            <% end %>
          </big>
        </div>
      <% end %>
      <% unless @event.hide_attendees? %>
        <div data-pagelet-url="/events/<%= @event.id %>/attendees">
          <%= partial :'events/attendees' %>
        </div>
      <% end %>
      <% if @event.zoom_party? %>
        <% if current_account %>
          <div data-pagelet-url="/zoom_parties?event_id=<%= @event.id %>"></div>
        <% else %>
          <p class="text-center lead mt-3">
            <a href="/accounts/new?event_id=<%= @event.id %>">Sign up</a> or <a href="/accounts/sign_in">sign in</a> to see the videocall links for this event
          </p>
        <% end %>
      <% end %>
    </div>
    <% if sidebar %>
      <%= partial :'events/sidebar' %>
    <% end %>
  </div>
  <%= partial :'events/feedback' %>
  <%= partial :'events/discussion' %>
<% end %>
