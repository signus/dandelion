<% upcoming_events = current_account.upcoming_events.paginate(page: params[:upcoming_events_page], per_page: 10) %>
<% past_events = current_account.previous_events.paginate(page: params[:past_events_page], per_page: 10) %>

<% if past_events.count > 0 %>
  <h3 class="mb-3">Upcoming events</h3>
<% end %>

<% if upcoming_events.count > 0 %>
  <%= partial :'events/blocks', locals: { events: upcoming_events } %>
  <div class="mt-3">
    <%= will_paginate upcoming_events, param_name: 'upcoming_events_page', inner_window: 0, outer_window: 0, renderer: WillPaginate::ViewHelpers::BootstrapRenderer %>
  </div>
<% else %>
  <div class="mb-3">
    <em>No upcoming events</em>
  </div>
<% end %>

<% if past_events.count > 0; events = past_events %>
  <h3 class="mb-3" id="past-events">Past events</h3>

  <% if events.count > 0 %>
    <div class="fake-container-fluid mb-3">
      <div class="row bg-grey-transparent-2 pt-4 px-5" id="events">
        <% events.each { |event| next if event.draft? && !event_admin?(event) %>
        <div class="col-12 <%= block_class if defined?(block_class) %>" id="<%= event.id %>">
          <div class="mb-4">

            <div class="row block no-gutters align-items-center <% if event.draft? %>bg-grey-transparent-2<% else %>bg-white<% end %>">
              <% if !event.image && (defined?(full_width) && full_width) %>

              <% else %>
                <div class="col-md-6 order-md-2 mb-2 mb-md-0">
                  <% if @organisation && (cohostship = event.cohostships.find_by(organisation: @organisation)) && cohostship.image && (cohostship.image.width >= cohostship.image.height) %>
                    <a target="_parent" href="/events/<%= event.id %>?cohost=<%=@organisation.slug%>"><img class="w-100" src="<%= u cohostship.image.thumb('640x640').url %>"></a>
                  <% elsif event.image && (event.image.width >= event.image.height) %>
                    <a target="_parent" href="/events/<%= event.id %>"><img class="w-100" src="<%= u event.image.thumb('640x640').url %>"></a>
                  <% end %>
                </div>
              <% end %>
              <div class="<% if !event.image && (defined?(full_width) && full_width) %>col-md-12<% else %>col-md-6<% end %> order-md-1">
                <table style="width: 100%; height: 100%">
                  <tr>
                    <td style="vertical-align: top">
                      <div class="row justify-content-between">
                        <div class="col ml-1 p-sm-3">
                          <%= partial :'events/block_main', locals: { event: event, skip_final_ul: true } %>
                          <li>

                            <% if (event_feedback = event.event_feedbacks.find_by(account: current_account)) %>
                            <div class="mt-1">
                            <% if event_feedback.rating %>
                              <% event_feedback.rating.times do %><i class="fa fa-star"></i><% end %>
                            <% end %>

                              <% event_feedback.event.feedback_questions_a.each_with_index { |q,i|
                                qa = event_feedback.answers.detect { |k, _v| k == q }
                                   a = qa[1] if qa
                                   if a
                                   %>
                              <p class="mt-1">
                                <strong>
                                  <%== Sanitize.fragment(Rinku.auto_link(q), Sanitize::Config::DANDELION) %>
                                </strong>
                                <br>
                                <%  %>
                                <% if a %>
                                  <%== Sanitize.fragment(Rinku.auto_link(a), Sanitize::Config::DANDELION) %>
                                <% end %>
                              </p>

                              <% end } %>
                            </div>
                            <% else %>
                              <i data-toggle="tooltip" title="Location" class="fa fa-li fa-star-o"></i>
                              <a href="/events/<%=event.id%>/give_feedback?t=<%=current_account.id%>">Give feedback</a>
                            <% end %>
                          </li>
                        </ul>


                        </div>
                      </div>
                    </td>
                  </tr>
                </table>
              </div>
            </div>



          </div>
        </div>
        <% } %>
      </div>
    </div>
    <style>
      @media(max-width: 767px) {
        .fake-container-fluid > .px-5 { padding-left: 1rem !important; padding-right: 1rem !important }
        .fake-container-fluid > .bg-grey-transparent-2 { background: white !important }
      }
    </style>
  <% end %>



  <div class="mt-3" id="past-events-pagination">
    <%= will_paginate past_events, param_name: 'past_events_page', inner_window: 0, outer_window: 0, renderer: WillPaginate::ViewHelpers::BootstrapRenderer %>
  </div>
  <script>
    $(function() { $('#past-events-pagination a').each(function() {  $(this).attr('href',$(this).attr('href')+'#past-events') } )})
  </script>
<% end %>
