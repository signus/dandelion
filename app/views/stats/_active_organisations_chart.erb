<%
d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)
data = d.map { |x|
  orders = Order.and(:created_at.gte => x, :created_at.lt => x + 1.month, :value.ne => nil)
  organisations = Organisation.and(:id.in => Event.and(:id.in => orders.pluck(:event_id)).pluck(:organisation_id))
  ["#{Date::MONTHNAMES[x.month]} #{x.year}", organisations.count]
}.to_h
%>
<%= partial(:chart, locals: { data: data }) %>
