<%

d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)
data = d.map { |x|
  start_time = x.to_time.utc
  end_time = (x + 1.month).to_time.utc
  orders = Order.and(:created_at.gte => start_time, :created_at.lt => end_time, :value.ne => nil)
  organisations = Organisation.and(:id.in => Event.and(:id.in => orders.pluck(:event_id)).pluck(:organisation_id))
  ["#{Date::MONTHNAMES[x.month]} #{x.year}", organisations.count]
}.to_h
%>
<%= partial(:chart, locals: { data: data }) %>
