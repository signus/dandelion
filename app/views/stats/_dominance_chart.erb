<%
d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)
organisation_id = Organisation.find_by(slug: ENV['LEAD_ORG_SLUG']).id
data = d.map { |x|
  start_time = x.to_time.utc
  end_time = (x + 1.month).to_time.utc
  lead_org_events_in_month = Event.and(organisation_id: organisation_id).and(:created_at.gte => start_time, :created_at.lt => end_time).count
  other_events_in_month = Event.and(:organisation_id.ne => organisation_id).and(:created_at.gte => start_time, :created_at.lt => end_time).count
  ["#{Date::MONTHNAMES[x.month]} #{x.year}", (lead_org_events_in_month == 0 || other_events_in_month == 0) ? 0 : (100*(lead_org_events_in_month.to_f/other_events_in_month)).round]
}.to_h 
%>
<%= partial(:chart, locals: { unit_after: '%', data: data }) %>
