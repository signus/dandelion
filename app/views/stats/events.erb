<%= partial :chart, locals: { label: 'Events', countable: Event.all, months_ago: 24 } %>

<%=

d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)

partial :chart, locals: {
  label: 'Dominance of leading organisation',
  unit_after: '%',
  data: d.map { |x|

    lead_org_events_in_month = Event.and(organisation: Organisation.find_by(slug: ENV['LEAD_ORG_SLUG'])).and(:created_at.gte => x, :created_at.lt => x + 1.month).count
    other_events_in_month = Event.and(:organisation.ne => Organisation.find_by(slug: ENV['LEAD_ORG_SLUG'])).and(:created_at.gte => x, :created_at.lt => x + 1.month).count

    ["#{Date::MONTHNAMES[x.month]} #{x.year}", lead_org_events_in_month == 0 ? 0 : (100*(other_events_in_month.to_f/lead_org_events_in_month)).round]
  }.to_h
}
%>

<%= 

d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)

partial :chart, locals: {
  label: 'Donations',
  unit: 'Â£',
  data: d.map { |x|
    account_contributions = AccountContribution.and(:created_at.gte => x, :created_at.lt => x + 1.month, :payment_completed => true)
    account_contributions_sum = account_contributions.count > 0 ? account_contributions.sum { |ac| Money.new(ac.amount*100, ac.currency) }.exchange_to('GBP') : 0

    organisation_contributions = OrganisationContribution.and(:created_at.gte => x, :created_at.lt => x + 1.month, :payment_completed => true)
    organisation_contributions_sum = organisation_contributions.count > 0 ? organisation_contributions.sum { |oc| Money.new(oc.amount*100, oc.currency) }.exchange_to('GBP') : 0

    ["#{Date::MONTHNAMES[x.month]} #{x.year}", (account_contributions_sum + organisation_contributions_sum).to_i]
  }.to_h
} %>
