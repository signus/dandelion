<% form_tag '', method: 'get', class: 'searchForm form-inline' do %>
  <div class="form-group">
    <label>Events between</label>
    <%= text_field_tag :from, class: 'form-control datepicker mx-1', value: @from.to_fs(:db_local) %>
  </div>
  <div class="form-group">
    <label>and</label>
    <%= text_field_tag :to, class: 'form-control datepicker mx-1', value: (@to.to_fs(:db_local) if @to) %>
  </div>
  <%= hidden_field_tag :search, value: 1 %>
  <%= submit_tag 'Search', class: 'btn btn-primary' %>
<% end %>

<%
  orders = Order.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil, :currency.in => MAJOR_CURRENCIES)  
  organisations = Organisation.and(:id.in => Event.and(:id.in => orders.pluck(:event_id)).pluck(:organisation_id))  
  tickets = Ticket.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :price.gt => 0)
%>
<p class="lead mt-3">
  <%= pluralize(organisations.count, 'organisation') %> sold
  <%= pluralize(tickets.count, 'ticket') %>
</p>

<div class="mt-3">

  <script>
    $(function () {
      var colIndex = $("#summary th").toArray().indexOf($("th[data-col-name='created_at']")[0])
      $('#summary').dataTable({bInfo: false, paging: false, searching: false, order: [[colIndex, "desc"]]});
    })
  </script>
  <table class="table" id="summary">
    <thead>
      <tr>
        <th>Organisation</th>
        <th data-col-name="events">Events</th>
        <th data-col-name="tickets">Tickets</th>
        <th data-col-name="value">Value</th>
        <th data-col-name="created_at">Created at</th>
        <th data-col-name="contribution">Contribution</th>
        <th data-col-name="remaining">Remaining</th>
      </tr>
    </thead>
    <% organisations = Organisation.and(:id.in => Event.and(:id.in => Order.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil).pluck(:event_id)).pluck(:organisation_id)) %>
    <% organisations.each { |organisation|
    
    tickets = Ticket.and(:event_id.in => organisation.events.pluck(:id), :created_at.gte => @from, :created_at.lt => @to + 1.day, :price.gt => 0)
    orders = Order.and(:event_id.in => organisation.events.pluck(:id), :created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil, :currency.in => MAJOR_CURRENCIES)
    events = Event.and(:id.in => tickets.pluck(:event_id))

    %>
    <tr>
      <td>
        <a href="/o/<%=organisation.slug%>"><%=organisation.name%></a>
      </td>
      <td>
        <%=events.count %>
      </td>
      <td>
        <%=tickets.count%>
      </td>
      <td data-sort="<%=organisation.created_at.to_fs(:db_local)%>"><%=organisation.created_at%></td>
      <% r = organisation.contribution_requested %>
      <% p = organisation.contribution_paid %>
      <td data-sort="<%=p/r%>">
        <%=m p, organisation.currency%>/<%=m r, organisation.currency%>
        <div class="progress" style="height: 30px">
          <div class="progress-bar" role="progressbar" style="width: <%= "#{w = 100*p.to_f/r.to_f}%" %>;">
            <% if w > 0 %><%= w.to_f.round %>%<% end %>
          </div>
        </div>
      </td>
      <td data-sort="<%=organisation.contribution_remaining.exchange_to('GBP')%>">
        <%=m organisation.contribution_remaining, organisation.currency%>
      </td>
    </tr>
    <% } %>
  </table>

</div>
