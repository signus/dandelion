<%=

d = [Date.new(24.months.ago.year, 24.months.ago.month, 1)]
d << (d.last + 1.month) while d.last < Date.new(Date.today.year, Date.today.month, 1)

partial :chart, locals: {
  label: 'Active organisations',
  data: d.map { |x|
    orders = Order.and(:created_at.gte => x, :created_at.lt => x + 1.month, :value.ne => nil)
    organisations = Organisation.and(:id.in => Event.and(:id.in => orders.pluck(:event_id)).pluck(:organisation_id))
    ["#{Date::MONTHNAMES[x.month]} #{x.year}", organisations.count]
  }.to_h   
} %>

<% form_tag '', method: 'get', class: 'searchForm form-inline' do %>
  <div class="form-group">
    <label>Events between</label>
    <%= text_field_tag :from, class: 'form-control datepicker mx-1', value: @from.to_fs(:db_local) %>
  </div>
  <div class="form-group">
    <label>and</label>
    <%= text_field_tag :to, class: 'form-control datepicker mx-1', value: (@to.to_fs(:db_local) if @to) %>
  </div>
  <div class="form-group">
    <label>Min. tickets</label>
    <%= number_field_tag :min_tickets, class: 'form-control mx-1', value: @min_tickets %>
  </div>
  <div class="form-group">
    <label>Min. order value</label>
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text">Â£</span>
      </div>
      <%= number_field_tag :min_order_value, style: 'width: 8em', class: 'form-control', value: @min_order_value %>
    </div>
  </div>
  <%= hidden_field_tag :search, value: 1 %>
  <%= submit_tag 'Search', class: 'btn btn-primary' %>
<% end %>

<%
  orders = Order.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil, :currency.in => MAJOR_CURRENCIES)  
  organisations = Organisation.and(:id.in => Event.and(:id.in => orders.pluck(:event_id)).pluck(:organisation_id))  
  tickets = Ticket.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :price.gt => 0)
%>
<p class="lead mt-3">
  <%= pluralize(organisations.count, 'organisation') %> sold
  <%= pluralize(tickets.count, 'ticket') %>
  worth
  <%= s = Money.new(0,'GBP'); orders.each { |o| s+= Money.new(o.value*100, o.currency) }; s.exchange_to('GBP').format(no_cents: true) %>
</p>

<div class="mt-3">

  <script>
    $(function () {
      var colIndex = $("#summary th").toArray().indexOf($("th[data-col-name='created_at']")[0])
      $('#summary').dataTable({bInfo: false, paging: false, searching: false, order: [[colIndex, "desc"]]});
    })
  </script>
  <table class="table" id="summary">
    <thead>
      <tr>
        <th>Organisation</th>
        <th data-col-name="events">Events</th>
        <th data-col-name="tickets">Tickets</th>
        <th data-col-name="value">Value</th>
        <th data-col-name="created_at">Created at</th>
        <th data-col-name="contribution">Contribution</th>
      </tr>
    </thead>
    <% organisations = Organisation.and(:id.in => Event.and(:id.in => Order.and(:created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil).pluck(:event_id)).pluck(:organisation_id)) %>
    <% organisations.each { |organisation|
    
    tickets = Ticket.and(:event_id.in => organisation.events.pluck(:id), :created_at.gte => @from, :created_at.lt => @to + 1.day, :price.gt => 0)
    orders = Order.and(:event_id.in => organisation.events.pluck(:id), :created_at.gte => @from, :created_at.lt => @to + 1.day, :value.ne => nil, :currency.in => MAJOR_CURRENCIES)
    events = Event.and(:id.in => tickets.pluck(:event_id))
    orders_sum = orders.sum { |o| Money.new(o.value*100, o.currency) }.exchange_to('GBP')

    next unless tickets.count >= @min_tickets || orders_sum >= Money.new(@min_order_value*100, 'GBP')

    %>
    <tr>
      <td>
        <a href="/o/<%=organisation.slug%>"><%=organisation.name%></a>
      </td>
      <td>
        <%=events.count %>
      </td>
      <td>
        <%=tickets.count%>
      </td>
      <td>
        <%= orders_sum.format(no_cents: true) %>
      </td>
      <td data-sort="<%=organisation.created_at.to_fs(:db_local)%>"><%=organisation.created_at%></td>
      <% r = organisation.contribution_requested %>
      <% p = organisation.contribution_paid %>
      <td data-sort="<%=p/r%>">
        <%=m p, organisation.currency%>/<%=m r, organisation.currency%>
        <div class="progress" style="height: 30px">
          <div class="progress-bar" role="progressbar" style="width: <%= "#{w = 100*p.to_f/r.to_f}%" %>;">
            <% if w > 0 %><%= w.to_f.round %>%<% end %>
          </div>
        </div>
      </td>
    </tr>
    <% } %>
  </table>

</div>
